/*
 * DeviceProtection.cpp
 *
 *  Created on: May 17, 2024
 *      Author: This PC
 */

#include "DeviceProtection.h"
#include "Analog.h"

namespace blib
{

    void DeviceProtection::backFlowControl()
    {
        auto &analog = Analog::getInstance();

        // PSU Mode
        if (mOutputMode == false)    // PSU mode: force backflow MOSFET on
        {
            mBypassEnable = true;
        }
        //Chagre Mode
        else
        {
            if (analog.getVin() > analog.getVout() + mVoltageDropout)
            {
                mBypassEnable = true;
            }
            else
            {
                mBypassEnable = false;
            }
        }

        HAL_GPIO_WritePin(ANTI_BACKFLOW_GPIO_Port, ANTI_BACKFLOW_Pin,
                (GPIO_PinState) mBypassEnable);
    }

}    // namespace blib

